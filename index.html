<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruleta | Cafe Santuario</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0b08;
      --panel: #1b120d;
      --card: #24170f;
      --accent: #d6a357;
      --accent-strong: #f2c26b;
      --text: #f4ecdf;
      --muted: #b99c83;
      --teal: #30b0a3;
      --red: #ef6461;
      --shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 20%, #1f130c, #0c0806 50%), radial-gradient(circle at 80% 0%, #1a120e, transparent 35%), #0b0604;
      padding: 24px;
    }
    .page { max-width: 1100px; margin: 0 auto; }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, rgba(28,18,13,0.75), rgba(38,25,16,0.9));
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .brand { font-family: 'Playfair Display', serif; letter-spacing: 0.8px; font-size: 20px; color: var(--accent-strong); }
    .title { font-size: 16px; color: var(--muted); }

    .layout { display: grid; grid-template-columns: 1fr; gap: 20px; justify-items: center; }

    .card {
      background: linear-gradient(180deg, #1b120c, #130c08);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      width: 100%;
    }

    .wheel-card { position: relative; overflow: hidden; }
    .wheel-wrap { position: relative; display: grid; place-items: center; padding: 10px 10px 20px; }
    .wheel-graphic {
      width: min(70vw, 520px);
      height: min(70vw, 520px);
      max-width: 520px;
      max-height: 520px;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 40%, rgba(255,255,255,0.08), rgba(0,0,0,0.35)), #0f0a07;
      border: 8px solid rgba(255,255,255,0.08);
      display: grid;
      place-items: center;
      position: relative;
      transition: transform 5s cubic-bezier(.17,.67,.08,1);
      box-shadow: 0 30px 80px rgba(0,0,0,0.45), inset 0 0 25px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.03);
    }
    canvas { width: 100%; height: 100%; }
    .pointer { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-bottom: 26px solid var(--accent-strong); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); z-index: 3; }
    .center-cap { position: absolute; width: 90px; height: 90px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(0,0,0,0.55)); border: 6px solid rgba(255,255,255,0.08); display: grid; place-items: center; color: var(--accent); font-family: 'Playfair Display', serif; letter-spacing: 0.5px; z-index: 2; pointer-events: none; }

    .controls-inline { display: flex; align-items: center; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
    button { border: none; cursor: pointer; font-weight: 600; letter-spacing: 0.2px; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; }
    .primary { background: linear-gradient(135deg, var(--accent), var(--accent-strong)); color: #1b120d; padding: 12px 18px; border-radius: 12px; font-size: 15px; min-width: 140px; text-transform: uppercase; letter-spacing: 0.6px; }
    .ghost { background: transparent; color: var(--muted); border: 1px dashed rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 10px; }
    .badge { background: rgba(48,176,163,0.18); color: #7be3d9; padding: 4px 8px; border-radius: 8px; font-size: 12px; letter-spacing: 0.4px; text-transform: uppercase; }
    .status { margin-top: 14px; padding: 12px 14px; background: rgba(255,255,255,0.05); border-radius: 12px; color: var(--muted); font-size: 14px; border: 1px solid rgba(255,255,255,0.05); }

    .list { max-height: 320px; overflow: auto; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.03); padding: 8px; margin-top: 12px; }
    .row { display: grid; grid-template-columns: 1fr; align-items: center; gap: 6px; padding: 8px; border-radius: 10px; background: rgba(0,0,0,0.18); margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.03); }

    .winner { display: inline-flex; align-items: baseline; gap: 6px; font-size: 16px; letter-spacing: 0.2px; color: var(--accent-strong); }
    .winner span { font-family: 'Playfair Display', serif; font-size: 22px; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: grid; place-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 10; }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }
    .modal { background: linear-gradient(180deg, #1b120c, #110a07); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 28px 32px; box-shadow: 0 40px 120px rgba(0,0,0,0.55); max-width: 640px; width: min(90vw, 700px); text-align: center; }
    .modal h2 { margin: 0 0 10px; font-family: 'Playfair Display', serif; font-size: 36px; letter-spacing: 0.6px; color: var(--accent-strong); }
    .modal .winner-name { font-family: 'Playfair Display', serif; font-size: clamp(36px, 6vw, 58px); margin: 6px 0 16px; color: var(--text); }
    .modal .subtext { color: var(--muted); letter-spacing: 0.2px; margin-bottom: 18px; }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar card">
      <div class="brand">Cafe Santuario</div>
      <div class="title">Ruleta de premiacion</div>
    </header>

    <main class="layout">
      <section class="card wheel-card">
        <div class="wheel-wrap">
          <div class="pointer"></div>
          <div class="wheel-graphic" id="wheelGraphic">
            <canvas id="wheel" width="600" height="600"></canvas>
            <div class="center-cap">Cafe</div>
          </div>
        </div>
        <div class="controls-inline">
          <button class="primary" id="spinBtn">Girar ruleta</button>
          <button class="ghost" id="loadXlsxBtn">Recargar XLSX</button>
          <div class="badge" id="totalSlots">Participantes: 0</div>
        </div>
        <div class="status" id="status">
          Carga participantes desde el Excel o presiona Recargar XLSX.
        </div>
        <div class="list" id="list"></div>
      </section>
    </main>
  </div>

  <div class="modal-backdrop" id="winnerModal">
    <div class="modal">
      <h2>¡Ganador!</h2>
      <div class="winner-name" id="winnerName">Nombre</div>
      <div class="subtext">Felicidades, disfruta tu premio de Cafe Santuario.</div>
      <button class="primary" id="closeModalBtn">Cerrar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const XLSX_FILE = 'participantes.xlsx'; // coloca aqui el .xlsx en el mismo directorio
    const FORCED_WINNER_NAME = 'NOMBRE_DEL_GANADOR_AQUI'; // cambia este texto por el nombre exacto a forzar
    const palette = ['#d6a357', '#30b0a3', '#ef6461', '#7ac08c', '#f27f5f', '#8ea1ff', '#c17aff', '#5cdbc4'];
    const wheelCanvas = document.getElementById('wheel');
    const ctx = wheelCanvas.getContext('2d');
    const wheelGraphic = document.getElementById('wheelGraphic');
    const list = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const totalSlots = document.getElementById('totalSlots');
    const winnerModal = document.getElementById('winnerModal');
    const winnerNameEl = document.getElementById('winnerName');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const loadXlsxBtn = document.getElementById('loadXlsxBtn');

    let participants = [];
    let spinning = false;
    let currentRotation = 0;

    function showModal(name) {
      winnerNameEl.textContent = name || 'Ganador';
      winnerModal.classList.add('show');
    }

    function hideModal() {
      winnerModal.classList.remove('show');
    }

    async function loadParticipantsFromXlsx() {
      statusEl.textContent = `Cargando participantes desde ${XLSX_FILE}...`;
      try {
        const res = await fetch(XLSX_FILE);
        if (!res.ok) throw new Error(`No se pudo leer ${XLSX_FILE}`);
        const data = await res.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        let nameCol = 0;
        let startRow = 0;
        for (let i = 0; i < rows.length; i++) {
          const idx = rows[i].findIndex(cell => String(cell).trim().toLowerCase() === 'nombre del cliente');
          if (idx !== -1) { nameCol = idx; startRow = i + 1; break; }
        }
        const names = rows.slice(startRow).map(row => String(row[nameCol] || '').trim()).filter(Boolean);
        participants = names.map(name => ({ name, weight: 1 }));
        renderList();
        statusEl.textContent = `Cargados ${names.length} participantes desde ${XLSX_FILE}.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Error cargando ${XLSX_FILE}. Ver consola.`;
      }
    }

    const displayParticipants = () => participants.filter(p => p.name.trim());
    function normalizedParticipants() {
      return participants.filter(p => p.name.trim() && p.weight > 0);
    }

    function drawWheel() {
      const visible = displayParticipants();
      const centerX = wheelCanvas.width / 2;
      const centerY = wheelCanvas.height / 2;
      const radius = wheelCanvas.width / 2 - 16;

      totalSlots.textContent = `Participantes: ${visible.length}`;
      ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

      if (!visible.length) {
        ctx.fillStyle = '#594634';
        ctx.textAlign = 'center';
        ctx.font = '20px "Space Grotesk"';
        ctx.fillText('Sin participantes cargados', centerX, centerY);
        return;
      }

      const slice = (Math.PI * 2) / visible.length;
      let startAngle = 0;
      visible.forEach((p, idx) => {
        const endAngle = startAngle + slice;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();

        const fill = palette[idx % palette.length];
        ctx.fillStyle = fill;
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + slice / 2);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#111';
        ctx.font = 'bold 16px "Space Grotesk"';
        ctx.fillText(p.name, radius - 16, 6);
        ctx.restore();

        startAngle = endAngle;
      });
    }

    function renderList() {
      list.innerHTML = '';
      participants.forEach((p) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.textContent = p.name;
        list.appendChild(row);
      });
      totalSlots.textContent = `Participantes: ${participants.length}`;
      drawWheel();
    }

    function spinWheel() {
      if (spinning) return;
      hideModal();
      const active = normalizedParticipants();
      const visible = displayParticipants();
      if (!visible.length) {
        statusEl.textContent = 'No hay participantes visibles. Carga el Excel.';
        return;
      }
      const forcedName = FORCED_WINNER_NAME.trim().toLowerCase();
      const forcedWinner = forcedName ? visible.find(p => p.name.trim().toLowerCase() === forcedName) : null;
      if (!active.length && !forcedWinner) {
        statusEl.textContent = 'Todos los participantes tienen peso 0. Configura FORCED_WINNER_NAME o pesos > 0.';
        return;
      }
      const total = active.reduce((sum, p) => sum + p.weight, 0);
      let winner = forcedWinner;

      if (!winner) {
        let rand = Math.random() * total;
        let cumulative = 0;
        active.forEach((p) => {
          cumulative += p.weight;
          if (!winner && rand <= cumulative) {
            winner = p;
          }
        });
      }

      if (!winner) {
        statusEl.textContent = 'No pudimos elegir ganador.';
        return;
      }

      const displayIndex = visible.findIndex((p) => p === winner);
      if (displayIndex === -1) {
        statusEl.textContent = 'No pudimos alinear el ganador con la ruleta visible.';
        return;
      }
      const sliceDeg = 360 / visible.length;
      const winnerStart = displayIndex * sliceDeg;
      const landingAngle = winnerStart + Math.random() * sliceDeg;
      const pointerAngle = 270 - landingAngle;
      const baseExtraTurns = 5;
      const randomExtra = Math.floor(Math.random() * 2);
      const minDegrees = 360 * (baseExtraTurns + randomExtra);
      let target = pointerAngle;
      while (target - currentRotation < minDegrees) {
        target += 360;
      }

      spinning = true;
      wheelGraphic.style.transform = `rotate(${target}deg)`;

      setTimeout(() => {
        spinning = false;
        currentRotation = target;
        statusEl.innerHTML = `<div class="winner">Ganador: <span>${winner.name}</span></div>`;
        showModal(winner.name);
      }, 5100);
    }

    document.getElementById('spinBtn').addEventListener('click', spinWheel);
    loadXlsxBtn.addEventListener('click', loadParticipantsFromXlsx);
    closeModalBtn.addEventListener('click', hideModal);
    winnerModal.addEventListener('click', (e) => { if (e.target === winnerModal) hideModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });

    renderList();
    drawWheel();
    loadParticipantsFromXlsx();
  </script>
</body>
</html>
